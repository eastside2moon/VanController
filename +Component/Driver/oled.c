

//
#include	<string.h>
#include "stm32f1xx_hal.h"

//OS
#include "cmsis_os.h"
#include "main.h"
//驱动


//硬件
#include "oled.h"

//字库
#include "font.h"

//C库
#include <stdarg.h>
#include <stdio.h>


OLED_INFO oled_info;


extern SPI_HandleTypeDef hspi1;


/*
************************************************************
	函数名称：	OLED_Delay

	函数功能：	OLED延时

	入口参数：	time：延时时间

	返回参数：	无

	说明：		基于当前延时时基
************************************************************
*/
__inline static void OLED_Delay ( unsigned int time )
{
    osDelay ( time );
}

/*
************************************************************
	函数名称：	OLED_WriteData

	函数功能：	OLED写入一个数据

	入口参数：	byte：需要写入的数据

	返回参数：	写入结果

	说明：		0-成功		1-失败
************************************************************
*/
_Bool OLED_WriteData ( unsigned char byte )
{
    OLCD_AO_H;
    HAL_SPI_Transmit ( &hspi1, &byte, 1, 2 );
    return 0;
}

/*
************************************************************
	函数名称：	OLED_WriteCom

	函数功能：	OLED写入一个命令

	入口参数：	cmd：需要写入的命令

	返回参数：	写入结果

	说明：		0-成功		1-失败
************************************************************
*/
_Bool OLED_WriteCom ( unsigned char cmd )
{
    OLCD_AO_L;
    HAL_SPI_Transmit ( &hspi1, &cmd, 1, 2 );
    return 0;
}

void OLED_Reset ( void )
{
    OLCD_RST_ON;
    OLED_Delay ( 20 );
    OLCD_RST_OFF;
    OLED_Delay ( 10 );
}

/*
************************************************************
	函数名称：	OLED_Init

	函数功能：	OLED初始化

	入口参数：	无

	返回参数：	无

	说明：
************************************************************
*/
void OLED_Init ( void )
{
    GPIO_InitTypeDef GPIO_InitStruct;
    /* GPIO Ports Clock Enable */
    __HAL_RCC_GPIOA_CLK_ENABLE();
    /*Configure GPIO pin Output Level */
    HAL_GPIO_WritePin ( GPIOA, GPIO_PIN_4 | GPIO_PIN_6, GPIO_PIN_RESET );
    /*Configure GPIO pins : PA4 PA6 */
    GPIO_InitStruct.Pin = GPIO_PIN_4 | GPIO_PIN_6;
    GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
    GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
    HAL_GPIO_Init ( GPIOA, &GPIO_InitStruct );
    OLED_Reset();
#if 1
    OLED_WriteCom ( 0xAE ); //关闭显示
    OLED_WriteCom ( 0x20 ); //Set Memory Addressing Mode
    OLED_WriteCom ( 0x10 ); //00,Horizontal Addressing Mode;01,Vertical Addressing Mode;10,Page Addressing Mode (RESET);11,Invalid
    OLED_WriteCom ( 0xb0 ); //Set Page Start Address for Page Addressing Mode,0-7
    OLED_WriteCom ( 0xa1 ); //0xa0，X轴正常显示；0xa1，X轴镜像显示
    OLED_WriteCom ( 0xc8 ); //0xc0，Y轴正常显示；0xc8，Y轴镜像显示
    OLED_WriteCom ( 0x00 ); //设置列地址低4位
    OLED_WriteCom ( 0x10 ); //设置列地址高4位
    OLED_WriteCom ( 0x40 ); //设置起始线地址
    OLED_WriteCom ( 0x81 ); //设置对比度值
    OLED_WriteCom ( 0x7f ); //------
    OLED_WriteCom ( 0xa6 ); //0xa6,正常显示模式;0xa7，
    OLED_WriteCom ( 0xa8 ); //--set multiplex ratio(1 to 64)
    OLED_WriteCom ( 0x3F ); //------
    OLED_WriteCom ( 0xa4 ); //0xa4,显示跟随RAM的改变而改变;0xa5,显示内容忽略RAM的内容
    OLED_WriteCom ( 0xd3 ); //设置显示偏移
    OLED_WriteCom ( 0x00 ); //------
    OLED_WriteCom ( 0xd5 ); //设置内部显示时钟频率
    OLED_WriteCom ( 0xf0 ); //------
    OLED_WriteCom ( 0xd9 ); //--set pre-charge period//
    OLED_WriteCom ( 0x22 ); //------
    OLED_WriteCom ( 0xda ); //--set com pins hardware configuration//
    OLED_WriteCom ( 0x12 ); //------
    OLED_WriteCom ( 0xdb ); //--set vcomh//
    OLED_WriteCom ( 0x20 ); //------
    OLED_WriteCom ( 0x8d ); //--set DC-DC enable//
    OLED_WriteCom ( 0x14 ); //------
    OLED_WriteCom ( 0xaf ); //打开显示
#else
    OLED_WriteCom ( 0xAE ); //display off
    OLED_WriteCom ( 0x00 );	//Set Memory Addressing Mode
    OLED_WriteCom ( 0x10 );	//00,Horizontal Addressing Mode;01,Vertical Addressing Mode;10,Page Addressing Mode (RESET);11,Invalid
    OLED_WriteCom ( 0x40 );	//Set Page Start Address for Page Addressing Mode,0-7
    OLED_WriteCom ( 0xb0 );	//Set COM Output Scan Direction
    OLED_WriteCom ( 0x81 ); //---set low column address
    OLED_WriteCom ( 0xff ); //---set high column address
    OLED_WriteCom ( 0xa1 ); //--set start line address
    OLED_WriteCom ( 0xa6 ); //--set contrast control register
    OLED_WriteCom ( 0xa8 );
    OLED_WriteCom ( 0x3f ); //--set segment re-map 0 to 127
    OLED_WriteCom ( 0xad ); //--set normal display
    OLED_WriteCom ( 0x8b ); //--set multiplex ratio(1 to 64)
    OLED_WriteCom ( 0x33 ); //
    OLED_WriteCom ( 0xc8 ); //0xa4,Output follows RAM content;0xa5,Output ignores RAM content
    OLED_WriteCom ( 0xd3 ); //-set display offset
    OLED_WriteCom ( 0x00 ); //-not offset
    OLED_WriteCom ( 0xd5 ); //--set display clock divide ratio/oscillator frequency
    OLED_WriteCom ( 0x80 ); //--set divide ratio
    OLED_WriteCom ( 0xd9 ); //--set pre-charge period
    OLED_WriteCom ( 0x1f ); //
    OLED_WriteCom ( 0xda ); //--set com pins hardware configuration
    OLED_WriteCom ( 0x12 );
    OLED_WriteCom ( 0xdb ); //--set vcomh
    OLED_WriteCom ( 0x40 ); //0x20,0.77xVcc
    //	IIC_Write_Command(0x8d);//--set DC-DC enable
    //	IIC_Write_Command(0x14);//
    OLED_WriteCom ( 0xaf ); //--turn on oled panel
#endif
    oled_info.device_ok = 1;
}

/*
************************************************************
	函数名称：	OLED_Exist

	函数功能：	OLED设备在线检查

	入口参数：	无

	返回参数：	0-未检测到	1-检测到

	说明：
************************************************************
*/
_Bool OLED_Exist ( void )
{
    //检测OLED
    if ( !OLED_WriteCom ( 0xAE ) )			//关闭显示，判断ACK
        oled_info.device_ok = 1;

    return oled_info.device_ok;
}

/*
************************************************************
	函数名称：	OLED_Address

	函数功能：	设置OLED显示地址

	入口参数：	x：行地址
				y：列地址

	返回参数：	无

	说明：
************************************************************
*/
void OLED_Address ( unsigned char x, unsigned char y )
{
    OLED_WriteCom ( 0xb0 + x );					//设置行地址
    //DelayUs(2);
    OLED_WriteCom ( ( ( y & 0xf0 ) >> 4 ) | 0x10 );	//设置列地址的高4位
    //DelayUs(2);
    OLED_WriteCom ( y & 0x0f );					//设置列地址的低4位
    //DelayUs(2);
}

/*
************************************************************
	函数名称：	OLED_ClearScreen

	函数功能：	OLED全屏清除

	入口参数：	无

	返回参数：	无

	说明：
************************************************************
*/
void OLED_ClearScreen ( void )
{
    if ( oled_info.device_ok )
        {
            unsigned char i = 0, j = 0;

            for ( ; i < 8; i++ )
                {
                    OLED_WriteCom ( 0xb0 + i );
                    OLED_WriteCom ( 0x10 );
                    OLED_WriteCom ( 0x00 );

                    for ( j = 0; j < 132; j++ )
                        OLED_WriteData ( 0x00 );
                }
        }
}

/*
************************************************************
	函数名称：	OLED_ClearAt

	函数功能：	OLED清除指定行

	入口参数：	x：需要清除的行

	返回参数：	无

	说明：
************************************************************
*/
void OLED_ClearAt ( unsigned char x )
{
    if ( oled_info.device_ok )
        {
            unsigned char i = 0;
            OLED_WriteCom ( 0xb0 + x );
            OLED_WriteCom ( 0x10 );
            OLED_WriteCom ( 0x00 );

            for ( ; i < 132; i++ )
                OLED_WriteData ( 0x00 );
        }
}

/*
************************************************************
	函数名称：	OLED_Dis12864_Pic

	函数功能：	显示一幅128*64的图片

	入口参数：	dp：图片数据指针

	返回参数：	无

	说明：
************************************************************
*/
void OLED_Dis12864_Pic ( const unsigned char *dp )
{
    if ( oled_info.device_ok )
        {
            unsigned char i = 0, j = 0;

            for ( ; j < 8; j++ )
                {
                    OLED_Address ( j, 0 );

                    for ( i = 0; i < 128; i++ )
                        OLED_WriteData ( *dp++ );		//写数据到LCD,每写完一个8位的数据后列地址自动加1
                }
        }
}

/*
************************************************************
	函数名称：	OLED_DisChar16x16

	函数功能：	显示16x16的点阵数据

	入口参数：	dp：图片数据指针

	返回参数：	无

	说明：		显示16x16点阵图像、汉字、生僻字或16x16点阵的其他图标
************************************************************
*/
void OLED_DisChar16x16 ( unsigned short x, unsigned short y, const unsigned char *dp )
{
    if ( oled_info.device_ok )
        {
            unsigned char i = 0, j = 0;

            for ( j = 2; j > 0; j-- )
                {
                    OLED_Address ( x, y );

                    for ( i = 0; i < 16; i++ )
                        OLED_WriteData ( *dp++ );		//写数据到OLED,每写完一个8位的数据后列地址自动加1

                    x++;
                }
        }
}

void OLED_DisStringFmt ( unsigned char line,  char *fmt, ... )
{
    //	if(oled_info.device_ok)
    //	{
    unsigned char oled_disbuf[24];
    unsigned char i = 0, c = 0, ch = 0, y, totalLength ;
    va_list ap;
    unsigned char *str = oled_disbuf;
    va_start ( ap, fmt );
    vsnprintf ( ( char * ) oled_disbuf, 17, fmt, ap );
    va_end ( ap );
    y = 2;
    totalLength = ( uint8_t ) strlen ( ( char * ) oled_disbuf ); //

    //Write string
    for ( c = 0; ( c < totalLength ) && ( c < LCD_MAX_LINE_LENGTH ); c++ )
        {
            ch = *str - 32;
            OLED_Address ( line * 2 - 2, y );

            for ( i = 0; i < 8; i++ )
                OLED_WriteData ( F8X16[ ( ch << 4 ) + i] );

            OLED_Address ( line * 2 - 1, y );

            for ( i = 0; i < 8; i++ )
                OLED_WriteData ( F8X16[ ( ch << 4 ) + i + 8] );

            str++;
            y += 8;
        }
    //Write space
    for ( c = totalLength;  c < LCD_MAX_LINE_LENGTH; c++ )
        {
            ch	=	0;
            OLED_Address ( line * 2 - 2, y );

            for ( i = 0; i < 8; i++ )
                OLED_WriteData ( F8X16[ ( ch << 4 ) + i] );

            OLED_Address ( line * 2 - 1, y );

            for ( i = 0; i < 8; i++ )
                OLED_WriteData ( F8X16[ ( ch << 4 ) + i + 8] );

            y += 8;
        }
}

/*
************************************************************
	函数名称：	OLED_DisString8x16

	函数功能：	显示8x16的点阵数据

	入口参数：	x：显示行
				y：显示列
				fmt：不定长参

	返回参数：	无

	说明：		能显示4行
************************************************************
*/
void OLED_DisString8x16 ( unsigned char x, unsigned char y, char *fmt, ... )
{
    if ( oled_info.device_ok )
        {
            unsigned char oled_disbuf[128];
            unsigned char i = 0, ch = 0;
            va_list ap;
            unsigned char *str = oled_disbuf;
            va_start ( ap, fmt );
            vsnprintf ( ( char * ) oled_disbuf, sizeof ( oled_disbuf ), fmt, ap );
            va_end ( ap );
            y += 2;

            while ( *str != '\0' )
                {
                    ch = *str - 32;

                    if ( y > 128 )
                        {
                            y = 2;
                            x += 2;
                        }

                    OLED_Address ( x, y );

                    for ( i = 0; i < 8; i++ )
                        OLED_WriteData ( F8X16[ ( ch << 4 ) + i] );

                    OLED_Address ( x + 1, y );

                    for ( i = 0; i < 8; i++ )
                        OLED_WriteData ( F8X16[ ( ch << 4 ) + i + 8] );

                    y += 8;
                    str++;
                }
        }
}
